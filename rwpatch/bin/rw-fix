#!/bin/sh
# rw-fix - Correct version with FULL nftables ruleset
# Fixes OpenVPN RW forwarding issues

say() { printf "\033[1;32m[rw-fix]\033[0m %s\n" "$*"; }
warn() { printf "\033[1;33m[rw-fix]\033[0m %s\n" "$*"; }
err() { printf "\033[1;31m[rw-fix]\033[0m %s\n" "$*"; }

say "Starting RW fix..."

# ========== Clean hijacked routes ==========
say "Cleaning hijacked default routes..."
ip route del 0.0.0.0/1      dev tun+ 2>/dev/null || true
ip route del 128.0.0.0/1    dev tun+ 2>/dev/null || true
ip route del default        dev tun+ 2>/dev/null || true
ip -6 route del ::/1        dev tun+ 2>/dev/null || true
ip -6 route del 2000::/3    dev tun+ 2>/dev/null || true
ip -6 route del default     dev tun+ 2>/dev/null || true

# ========== Detect interfaces ==========
say "Detecting interfaces..."

# RW server interface (tun0)
SRV_IF=$(ip -o link show | awk -F': ' '/: tun0:/ {print $2}' | head -1)
if [ -z "$SRV_IF" ]; then
    SRV_IF="tun0"
    warn "tun0 not found, using default name"
fi

# External upstream VPN interface (tun1, tun2, etc - first one with IP)
EXT_IF=$(ip -o link show | awk -F': ' '/: tun[1-9]/ {print $2}' | while read -r dev; do
    ip -4 addr show dev "$dev" 2>/dev/null | grep -q 'inet ' && echo "$dev" && break
done)

# Public interface
PUB_DEV=$(ip -4 route show default 2>/dev/null | awk '{print $5; exit}')
[ -z "$PUB_DEV" ] && PUB_DEV="br-lan"

say "Detected interfaces:"
say "  RW server (SRV_IF): $SRV_IF"
say "  Upstream VPN (EXT_IF): ${EXT_IF:-<none>}"
say "  Public (PUB_DEV): $PUB_DEV"

# ========== Enable IP forwarding ==========
say "Enabling IP forwarding..."
sysctl -w net.ipv4.ip_forward=1 >/dev/null
sysctl -w net.ipv6.conf.all.forwarding=1 >/dev/null

# Disable rp_filter (important for VPN)
for n in all default; do
    sysctl -w net.ipv4.conf.$n.rp_filter=0 >/dev/null 2>&1 || true
done

# ========== Stop fw4 (conflicts with our nftables) ==========
if /etc/init.d/firewall status >/dev/null 2>&1; then
    say "Stopping fw4 firewall..."
    /etc/init.d/firewall stop 2>/dev/null || true
fi

# ========== Create COMPLETE nftables ruleset ==========
say "Creating nftables ruleset (inet rwfix)..."

# Delete old table
nft delete table inet rwfix 2>/dev/null || true

# Create new complete ruleset
nft -f - <<EOF
# ========== Table: inet rwfix ==========
add table inet rwfix

# ========== Chain: POSTROUTING (NAT/Masquerade) ==========
add chain inet rwfix post {
    type nat hook postrouting priority srcnat; policy accept;
}

# Masquerade for RW clients going to upstream or internet
add rule inet rwfix post iifname "$SRV_IF" oifname != "$SRV_IF" masquerade

# ========== Chain: INPUT (allow management) ==========
add chain inet rwfix input {
    type filter hook input priority filter; policy accept;
}

# Allow established/related
add rule inet rwfix input ct state established,related accept

# Allow loopback
add rule inet rwfix input iif lo accept

# Allow ICMP (ping)
add rule inet rwfix input ip protocol icmp accept
add rule inet rwfix input ip6 nexthdr ipv6-icmp accept

# Allow SSH (port 22)
add rule inet rwfix input tcp dport 22 accept

# Allow LuCI (ports 80, 443)
add rule inet rwfix input tcp dport 80 accept
add rule inet rwfix input tcp dport 443 accept

# Allow OpenVPN RW server (port from UCI)
add rule inet rwfix input udp dport 23100 accept

# Allow DNS from RW clients
add rule inet rwfix input iifname "$SRV_IF" udp dport 53 accept
add rule inet rwfix input iifname "$SRV_IF" tcp dport 53 accept

# ========== Chain: FORWARD (CRITICAL!) ==========
add chain inet rwfix forward {
    type filter hook forward priority filter; policy accept;
}

# Allow established/related (IMPORTANT!)
add rule inet rwfix forward ct state established,related accept

# Allow RW clients → upstream VPN
add rule inet rwfix forward iifname "$SRV_IF" oifname "$EXT_IF" accept

# Allow upstream VPN → RW clients
add rule inet rwfix forward iifname "$EXT_IF" oifname "$SRV_IF" accept

# Allow RW clients → internet (if no upstream VPN)
add rule inet rwfix forward iifname "$SRV_IF" accept

# MSS clamping for RW clients (fix MTU issues)
add rule inet rwfix forward iifname "$SRV_IF" tcp flags syn tcp option maxseg size set 1400
add rule inet rwfix forward oifname "$SRV_IF" tcp flags syn tcp option maxseg size set 1400

# ========== Chain: OUTPUT (allow all) ==========
add chain inet rwfix output {
    type filter hook output priority filter; policy accept;
}
EOF

if [ $? -eq 0 ]; then
    say "✓ nftables ruleset created successfully"
else
    err "✗ Failed to create nftables ruleset"
    exit 1
fi

# ========== Policy-based routing (optional, if upstream VPN exists) ==========
if [ -n "$EXT_IF" ]; then
    say "Setting up policy-based routing..."
    
    # Add vpnout table to rt_tables
    grep -qE '^[[:space:]]*100[[:space:]]+vpnout$' /etc/iproute2/rt_tables || \
        echo '100 vpnout' >> /etc/iproute2/rt_tables
    
    # Clean old rules
    while ip rule show | grep -q "lookup vpnout"; do
        pref=$(ip rule show | awk '/vpnout/ {print $1}' | head -n1)
        [ -n "$pref" ] && ip rule del pref "$pref" || break
    done
    
    # Flush vpnout table
    ip route flush table vpnout 2>/dev/null || true
    
    # Add default route via upstream VPN
    ip route replace table vpnout default dev "$EXT_IF"
    
    # Add rule: traffic from RW server → vpnout table
    ip rule add pref 110 iif "$SRV_IF" lookup vpnout
    
    say "✓ Policy routing: $SRV_IF → table vpnout (default via $EXT_IF)"
else
    say "⚠ No upstream VPN detected - RW traffic will use main routing table"
fi

# ========== Restart services ==========
say "Restarting services..."
/etc/init.d/dnsmasq restart 2>/dev/null || true
/etc/init.d/openvpn restart 2>/dev/null || true

# ========== Verification ==========
say "Verifying setup..."

# Check nftables
if nft list table inet rwfix >/dev/null 2>&1; then
    say "✓ nftables table 'inet rwfix' exists"
else
    err "✗ nftables table 'inet rwfix' NOT found"
fi

# Check forwarding
if [ "$(sysctl -n net.ipv4.ip_forward)" = "1" ]; then
    say "✓ IP forwarding enabled"
else
    warn "⚠ IP forwarding NOT enabled"
fi

# Check OpenVPN
if pgrep -f "openvpn.*rw" >/dev/null; then
    say "✓ OpenVPN RW server running"
else
    warn "⚠ OpenVPN RW server NOT running"
fi

# ========== Summary ==========
say ""
say "=========================================="
say "RW-FIX COMPLETED!"
say "=========================================="
say ""
say "Configuration:"
say "  RW server interface: $SRV_IF"
say "  Upstream VPN interface: ${EXT_IF:-<none>}"
say "  Public interface: $PUB_DEV"
say ""
say "nftables chains created:"
say "  ✓ inet rwfix post (NAT/masquerade)"
say "  ✓ inet rwfix input (management access)"
say "  ✓ inet rwfix forward (packet forwarding)"
say "  ✓ inet rwfix output (allow all)"
say ""
say "Forwarding: ENABLED"
say "Policy routing: ${EXT_IF:+ENABLED via $EXT_IF}"
say ""
say "To verify: nft list table inet rwfix"
say "To check routes: ip route; ip rule"
say "To check OpenVPN: ps | grep openvpn"
say ""
say "Done! ✨"
